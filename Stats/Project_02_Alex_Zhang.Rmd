---
title: "Project 2"
author: "Alex Zhang"
date: "2022-11-11"
output:
  pdf_document: default
  pdf: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(pscl)
serengeti <- read.csv("https://sta214-f22.github.io/projects/serengeti.csv")
```
```{r}
logodds_plot <- function(data, num_bins, bin_method,
                         x_name, y_name, grouping = NULL, reg_formula = y ~ x){
  
  if(is.null(grouping)){
    dat <- data.frame(x = data %>% pull(x_name), 
                      y = data %>% pull(y_name),
                      group = 1)
  } else {
    dat <- data.frame(x = data %>% pull(x_name), 
                      y = data %>% pull(y_name),
                      group = data %>% pull(grouping))
  }
  
  if(bin_method == "equal_size"){
    logodds_table <- dat %>%
      drop_na() %>%
      arrange(group, x) %>%
      group_by(group) %>%
      mutate(obs = y,
             bin = rep(1:num_bins,
                       each=ceiling(n()/num_bins))[1:n()]) %>%
      group_by(bin, group) %>%
      summarize(mean_x = mean(x),
                prop = mean(c(obs, 0.5)),
                num_obs = n()) %>%
      ungroup() %>%
      mutate(logodds = log(prop/(1 - prop)))
  } else {
    logodds_table <- dat %>%
      drop_na() %>%
      group_by(group) %>%
      mutate(obs = y,
             bin = cut(x, 
                       breaks = num_bins,
                       labels = F)) %>%
      group_by(bin, group) %>%
      summarize(mean_x = mean(x),
                prop = mean(c(obs, 0.5)),
                num_obs = n()) %>%
      ungroup() %>%
      mutate(logodds = log(prop/(1 - prop)))
  }
  
  if(is.null(grouping)){
    logodds_table %>%
      ggplot(aes(x = mean_x,
                 y = logodds)) +
      geom_point(size=2) +
      geom_smooth(se=F, method="lm", formula = reg_formula) +
      theme_bw() +
      labs(x = x_name,
           y = "Empirical log odds") +
      theme(text = element_text(size=25))
  } else {
    logodds_table %>%
      ggplot(aes(x = mean_x,
                 y = logodds,
                 color = group,
                 shape = group)) +
      geom_point(size=2) +
      geom_smooth(se=F, method="lm", formula = reg_formula) +
      theme_bw() +
      labs(x = x_name,
           y = "Empirical log odds",
           color = grouping,
           shape = grouping) +
      theme(text = element_text(size=25))
  }
  
}
```
```{r}
logmean_plot <- function(data, num_bins, bin_method,
                         x, y, grouping = NULL, reg_formula = y ~ x){
  
  if(is.null(grouping)){
    dat <- data.frame(x = data[,x], 
                      y = data[,y],
                      group = 1)
  } else {
    dat <- data.frame(x = data[,x], 
                      y = data[,y],
                      group = data[,grouping])
  }
  
  if(bin_method == "equal_size"){
    log_table <- dat %>%
      drop_na() %>%
      arrange(group, x) %>%
      group_by(group) %>%
      mutate(obs = y,
             bin = rep(1:num_bins,
                       each=ceiling(n()/num_bins))[1:n()]) %>%
      group_by(bin, group) %>%
      summarize(mean_x = mean(x),
                mean_y = mean(obs),
                num_obs = n()) %>%
      ungroup() %>%
      mutate(log_mean = log(mean_y))
  } else {
    log_table <- dat %>%
      drop_na() %>%
      group_by(group) %>%
      mutate(obs = y,
             bin = cut(x, 
                       breaks = num_bins,
                       labels = F)) %>%
      group_by(bin, group) %>%
      summarize(mean_x = mean(x),
                mean_y = mean(obs),
                num_obs = n()) %>%
      ungroup() %>%
      mutate(log_mean = log(mean_y))
  }
  
  if(is.null(grouping)){
    log_table %>%
      ggplot(aes(x = mean_x,
                 y = log_mean)) +
      geom_point(size=2.5) +
      geom_smooth(se=F, method="lm", formula = reg_formula) +
      theme_bw() +
      labs(x = x,
           y = "Empirical log mean count") +
      theme(text = element_text(size=25))
  } else {
    log_table %>%
      ggplot(aes(x = mean_x,
                 y = log_mean,
                 color = group,
                 shape = group)) +
      geom_point(size=2.5) +
      geom_smooth(se=F, method="lm", formula = reg_formula) +
      theme_bw() +
      labs(x = x,
           y = "Empirical log mean count",
           color = grouping,
           shape = grouping) +
      theme(text = element_text(size=25))
  }
  
}

```



## Abstract


## Section 1: Introduction



## Section 2: Data




```{r}
serengeti <- serengeti %>%
  drop_na()
glimpse(serengeti)
```

After trying to drop the missing data, it still exists 966 rows and 15 columns which indicate there is no missing data. 

Based on the summary of the data, each row it represents the information for a site with specific date. Each row also contains the the count and appearance of certain species and some other environmental factors. There are total 966 rows and 15 columns. The data set contains information about the site id, recorded date, gazalle's count and appearance, topi count, zebra count, and other environmental factors like whether having wildfire or having enough vegetation.

```{r}
ggplot(data = serengeti, aes(x = gazelleThomsons.count)) + geom_histogram(binwidth = 10, fill = "blue") + labs(title = "Figure 2.1", x = "Number of Gazelle", y = "Count")
```
Based on Figure 2.1, we can observe that the number of gazelle Thomsons in these sites ar 0 in most sites. There are also hundreds of gazelle Thomsons in some specific areas.

```{r}
ggplot(data = serengeti, aes(x = topi.count)) + geom_histogram(binwidth = 0.3, fill = "blue") + labs(title = "Figure 2.2", x = "Number of Topi", y = "Count")
```
Based on Figure 2.2, it shows that in most recorded sites, the number of topi is 0 and there are few of them in some specific sites.


```{r}
ggplot(data = serengeti, aes(x = zebra.count)) + geom_histogram(binwidth = 10, fill = "blue") + labs(title = "Figure 2.3", x = "Number of Zebra", y = "Count")
```

Based on Figure 2.3, we can also conclude that the number of zebra in most sites is 0.




```{r}
logmean_plot(data = serengeti, 60, "equal_size","ndvi", "topi.count", reg_formula = y ~ x) + labs(title = "Figure 2.4", x = "NDVI")
```

As showed from Figure 2.4, the relationship between the number of topi and the vegetation condition is also linear since points are bouncing around the linear which means no transformation needed.


```{r}
logmean_plot(data = serengeti, 60, "equal_size","ndvi", "zebra.count", reg_formula = y ~ poly(x,2)) + labs(title = "Figure 2.5", x = "NDVI")
```
Based on Figure 2.5, the relationship between the number of zebra and the vegetation condition is nonlinear. So the polynomial transformation with a power of two is needed.



```{r}
logmean_plot(data = serengeti, 60, "equal_size","ndvi", "gazelleThomsons.count", reg_formula = y ~ x) + labs(title = "Figure 2.6", x = "NDVI")
```

Based on Figure 2.6, the relationship between vegetation condition and the number of gazelle can be defined as linear since there is no explicit shape. No transformation is required.

```{r}
logmean_plot(data = serengeti, 60, "equal_size",x = "amRivDist",  y = "topi.count", reg_formula = y ~ (x)) + labs(title = "Figure 2.7", x = "River Distance")
```

Based on Figure 2.7, ideally no transformation is needed for the relation between river distance and the number of topi. However, since the numbers for river distance are really large, outweighted other variablers, I choose to do the log transformation on it.



```{r}
logmean_plot(data = serengeti, 60, "equal_size",x = "amRivDist",  y = "zebra.count", reg_formula = y ~ x) + labs(title = "Figure 2.8", x = "River Distance")
```

As Figure 2.8 shows, it is also reasonable to have a log transformation with the same reason for the relation between river distance and the number of topi.




```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "amRivDist", y = "gazelleThomsons.count", reg_formula = y ~ (x)) +  labs(title = "Figure 2.9", x = "River Distance")
```

Based on Figure 2.9, having a log transformation is reasonable for the relation between the number of gazelle and the river distance.

```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "TM100", y = "topi.count", reg_formula = y ~ x) + labs(title = "Figure 2.10", x = "Number of Termite Mound")
```

Based on Figure 2.10, no transformation is needed since it is hard to describe the shape.


```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "TM100", y = "zebra.count", reg_formula = y ~ x) + labs(title = "Figure 2.11", x = "Number of Termite Mound")
```

Based on Figure 2.11, there is also no transformation needed for the relationship between the number of zebra and the number of termite mounds since most of the points is about around the line.


```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "TM100", y = "gazelleThomsons.count", reg_formula = y ~ x) + labs(title = "Figure 2.12", x = "Number of Termite Mound")
```

Based on the Figure 2.12, the relation between number of termite and the number of gazelle does not need to do any transformation.


```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "T50", y = "topi.count", reg_formula = y ~ x) + labs(title = "Figure 2.13", x = "Number of Trees")
```

Based on the Figure 2.13, there is no transformation needed for the number of trees and the number of topi.

```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "T50", y = "zebra.count", reg_formula = y ~ x)  + labs(title = "Figure 2.14", x = "Number of Trees")
```

Based on Figure 2.14,  no transformation is required for the number of trees and number of zebra. 

```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "T50", y = "gazelleThomsons.count", reg_formula = y ~ x)   + labs(title = "Figure 2.15", x = "Number of Trees")
```

As Figure 2.15 shows, only doing linear transformation for the relationship between number of gazelle and number treesis fine.


```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "LriskDry", y = "topi.count", reg_formula = y ~ x)  + labs(title = "Figure 2.16", x = "Risky to Lion")
```

As shown in Figure 2.16, it is reasonable to not have any transformation between the risk to lion and the number of topi.

```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "LriskDry", y = "zebra.count", reg_formula = y ~ (x))  + labs(title = "Figure 2.17", x = "Risky to Lion")
```

Based on Figure 2.17, no transformation is needed for the relationship between the number of zebra and the risk to lion in certain site.

```{r}
logmean_plot(data = serengeti, 60, "equal_size", x = "LriskDry", y = "gazelleThomsons.count", reg_formula = y ~ (x)) +   labs(title = "Figure 2.18", x = "Risky to Lion")
```

From the Figure 2.18, it shows that just having linear transformation for the relation between the risk to lion and number of gazelle.

```{r}
serengeti <- serengeti %>%
  mutate(fire = as.factor(fire))
ggplot(data = serengeti, aes(x = fire)) + geom_bar(fill = "blue") + labs(title = "Figure 2.19", x = "Whether has fire")
```

Based on Figure 2.19, the $fire$ variable is very discrete and there is only one row showing that there is a wild fire. So this variable will not be chosen to include in the models since there is rarely relation between the number of species and whether has a wild fire.


## Section 3: Modeling

In the modeling section, since based on the Figure 2.1, 2.2, and 2.3 showed, three ZIP models for each species are required since there are excessive number of 0 in each species counts.


### Section 3.1: Importance of enviornment variables
For three different species, the population model will be the same. The population model for logistic regression part will be:
$$Z_i \sim Bernoulli(\alpha_i)$$
$$\log \left ( \frac{\alpha_i}{1-\alpha_i} \right ) = \gamma_0 + \gamma_1ndvi_i + \gamma_2log(amRivDist_i) + \gamma_3TM100_i + \gamma_4LriskDry_i + \gamma_5T50_i$$

The Poisson part will be:
$$Y_i \sim Poisson(\lambda_i)$$

$$\log \left( \lambda_i \right) = \beta_0 + \beta_1ndvi_i + \beta_2log(amRivDist_i) + \beta_3TM100_i + \beta_4LriskDry_i + \beta_5T50_i$$

For specie topi, the summary for fitted regression model will be:
```{r}
zip_m1 <- zeroinfl(topi.count ~ ndvi + log(amRivDist) + TM100 + LriskDry + T50 | ndvi  + log(amRivDist) + TM100 + LriskDry + T50 , data = serengeti)
summary(zip_m1)
```

Based on the summary, the fitted regression line for topi will be:
$$\log \left ( \frac{\alpha_i}{1-\alpha_i} \right ) = 1.889 - 1.252ndvi_i + 0.241log(amRivDist_i) -0.0227 TM100_i -154.3riskDry_i - 0.0011T50_i$$
$$\log \left( \lambda_i \right) = 1.779 -0.241ndvi_i -0.152log(amRivDist_i) -0.204TM100_i +  62.511LriskDry_i +0.0006T50_i$$
The summary for the fitted regression line for zebra will be:
```{r}
zip_m2 <- zeroinfl(zebra.count ~ ndvi + log(amRivDist) + TM100 + LriskDry + T50 | ndvi + log(amRivDist) + TM100 + LriskDry + T50, data = serengeti)
summary(zip_m2)
```

For specie zebra, the fitted regression line will be:
$$\log \left ( \frac{\alpha_i}{1-\alpha_i} \right ) = -0.2919 + 0.467ndvi_i + 0.0946log(amRivDist_i)+0.216TM100_i + 65.8486riskDry_i - 0.0011T50_i$$
$$\log \left( \lambda_i \right) = 3.157 - 0.5754ndvi_i -0.0215log(amRivDist_i) -0.1495TM100_i - 23.7LriskDry_i +0.0006T50_i$$

The summary fitted regresion model for specie gazelle will be:
```{r}
zip_m3 <- zeroinfl(gazelleThomsons.count ~ ndvi + log(amRivDist) + TM100 + LriskDry + T50  | ndvi + log(amRivDist) + TM100 + LriskDry + T50, data = serengeti)
summary(zip_m3)
```


The fitted regression line for gazelle will be:
$$\log \left ( \frac{\alpha_i}{1-\alpha_i} \right ) = 0.5805 + 5.235ndvi_i - 0.1815log(amRivDist_i) + 0.6865TM100_i + 43.7LriskDry_i + 0.00003T50_i$$
$$\log \left( \lambda_i \right) = -0.0422 -2.816ndvi_i + 0.5595log(amRivDist_i) -0.3943TM100_i - 102.3LriskDry_i - 0.0026T50_i$$

With the given research question, I will first test whether environmental variables have relationship with the number of topi in data set.

### Topi

#### Test 1
The first test is testing whether there is a relation between the vegetation condition (ndvi) and topi count.
The hypothesis test will be
$$H_0: \beta_1 = 0$$
$$H_a: \beta_1 \neq 0$$
The log likelihood for the full model will be:
```{r}
zip_m3$loglik
```

The log likelihood for the reduced model will be:
```{r}
zip_m4 <- zeroinfl(gazelleThomsons.count ~  log(amRivDist) + TM100 + LriskDry + T50  | ndvi + log(amRivDist) + TM100 + LriskDry + T50, data = serengeti)
zip_m4$loglik
```
The test statistic $G$ will be $2(-2963.71-(-3048.128)) = 168.836$

Using $\chi^2$ distribution, the p-value will be
```{r}
pchisq(168.836, df = 1, lower.tail = FALSE)
```
Since the p-value is very close to 0, we can conclude that we there is a strong relationship between the topi count and the vegetation condition (ndvi).


####



### Section 3.2: Comparing species

```{r}

```




## Section 4: Discussion















































